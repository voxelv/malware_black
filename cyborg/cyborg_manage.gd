extends Node

signal send_pressed

# Vars
var live_sw = null
var max_health = 100
var health = max_health
var max_armor = 100
var armor = max_armor

# onready Nodes
onready var cyborg_name = find_node("cyborg_name")
onready var cyborg = find_node("cyborg")
onready var cyborg_stats = find_node("cyborg_stats")
onready var health_meter = find_node("body_health_meter")
onready var armor_meter = find_node("body_armor_meter")
onready var repair_armor_button = find_node("repair_armor_button")
onready var heal_body_button = find_node("heal_body_button")
onready var manage_gadgets_button = find_node("manage_gadgets_button")
onready var gadgets_popup = find_node("gadgets_popup")
onready var send_button = find_node("send_button")
onready var cyborg_parent = find_node("cyborg_parent")

func _ready():
	# TEMPORARY:
	health = int(randi() % max_health)
	armor = int(randi() % max_armor)
	
	cyborg_name.text = mb_lib.CYBORG_NAMES[randi() % len(mb_lib.CYBORG_NAMES)]
	cyborg.display_name = cyborg_name.text
	
	cyborg.add_part(factory.new_cyborg_part(0, null, 1, 2, 3))
	cyborg.add_part(factory.new_cyborg_part(1, null, 1, 2, 3))
	cyborg.add_part(factory.new_cyborg_part(2, null, 1, 2, 3))
	cyborg.add_part(factory.new_cyborg_part(3, null, 3, 4, 5))
	
	# Connections
	cyborg_name.connect("text_entered", self, "name_entered")
	heal_body_button.connect("pressed", self, "heal_body_button_pressed")
	repair_armor_button.connect("pressed", self, "repair_armor_button_pressed")
	manage_gadgets_button.connect("pressed", self, "manage_gadgets_button_pressed")
	send_button.connect("pressed", self, "send_button_pressed")
	gadgets_popup.connect("part_update", self, "part_update")

func _process(delta):
	update_cyborg_gui()

func set_data(max_health, max_armor):
	self.max_health = max_health
	self.max_armor = max_armor

func update_cyborg_gui():
	health_meter.value = (float(health) / float(max_health)) * health_meter.max_value
	armor_meter.value = (float(armor) / float(max_armor)) * armor_meter.max_value
	
	if armor < max_armor:
		repair_armor_button.set_disabled(false)
		var repair_armor_values = {
			"amt": calculate_armor_repair_cost(), 
			"currency": mb_lib.CURRENCY
			}
		repair_armor_button.text = "REPAIR ({amt}{currency})".format(repair_armor_values)
	else:
		repair_armor_button.set_disabled(true)
		repair_armor_button.text = "REPAIR"

	var heal_btn = heal_body_button
	if health < max_health:
		heal_body_button.set_disabled(false)
		var heal_values = {
			"amt": calculate_heal_cost(),
			"currency": mb_lib.CURRENCY
			}
		heal_body_button.text = "HEAL ({amt}{currency})".format(heal_values)
	else:
		heal_body_button.set_disabled(true)
		heal_body_button.text = "HEAL"
	
	cyborg_stats.update_stats(cyborg, live_sw)

func set_live_sw(new_live_sw):
	live_sw = new_live_sw

func add_cyborg_part(type, version):
	var new_part = factory.new_cyborg_part(type, version)
	cyborg.add_part(new_part)

func calculate_armor_repair_cost():
	return(max_armor - armor)

func calculate_heal_cost():
	return(max_health - health)

func name_entered(new_text):
	cyborg.display_name = new_text
	cyborg_name.release_focus()

func heal_body_button_pressed():
	var cost = calculate_heal_cost()
	# TODO: TAKE CURRENCY OUT OF BANK
	health = max_health

func repair_armor_button_pressed():
	var cost = calculate_armor_repair_cost()
	# TODO: TAKE CURRENCY OUT OF BANK
	armor = max_armor

func manage_gadgets_button_pressed():
	gadgets_popup.update_data(cyborg, live_sw)
	gadgets_popup.popup_centered_minsize(Vector2(250, 100))

func set_send_button_disabled(new_disabled):
	send_button.disabled = new_disabled

func get_cyborg_name():
	return cyborg.display_name

func part_update(type):
	cyborg.set_software(type, live_sw[type])
	gadgets_popup.update_data(cyborg, live_sw)

func send_button_pressed():
	emit_signal("send_pressed", get_index())

func take_cyborg():
	cyborg_parent.remove_child(cyborg)
	return(cyborg)



