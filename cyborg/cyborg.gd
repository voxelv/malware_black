extends Node

# Node Names
const CYBORG_NAME = "cyborg_name"
const BODY_HEALTH_METER = "body_health_meter"
const BODY_ARMOR_METER = "body_armor_meter"
const HEAL_BODY_BUTTON = "heal_body_button"
const REPAIR_ARMOR_BUTTON = "repair_armor_button"
const MANAGE_CYBORG_PARTS_BUTTON = "manage_cyborg_parts_button"
const MANAGE_CYBORG_PARTS_POPUP = "manage_cyborg_parts_popup"
const CYBORG_PARTS_NODE_NAME = "cyborg_parts_node_name"
const CYBORG_PARTS_VIEW_NODE = "cyborg_parts_view_node"
const CYBORG_PARTS_DATA = "cyborg_parts_data"
const CYBORG_PARTS_LIST = "cyborg_parts_list"

# Preloads
var cyborg_part_preload = preload("res://cyborg/cyborg_part.gd")

# Vars
var cyborg_name = ""
var max_health = 100
var body_health = max_health
var max_armor = 100
var body_armor = max_armor
var cyborg_parts = {
	mb_lib.CYBORG_PART_TYPE_HANDS: 	{CYBORG_PARTS_NODE_NAME: "cyborg_hands", 	CYBORG_PARTS_VIEW_NODE: null},
	mb_lib.CYBORG_PART_TYPE_ARMS: 	{CYBORG_PARTS_NODE_NAME: "cyborg_arms", 	CYBORG_PARTS_VIEW_NODE: null},
	mb_lib.CYBORG_PART_TYPE_EYES: 	{CYBORG_PARTS_NODE_NAME: "cyborg_eyes", 	CYBORG_PARTS_VIEW_NODE: null},
	mb_lib.CYBORG_PART_TYPE_TORSO: 	{CYBORG_PARTS_NODE_NAME: "cyborg_torso", 	CYBORG_PARTS_VIEW_NODE: null},
	mb_lib.CYBORG_PART_TYPE_LEGS: 	{CYBORG_PARTS_NODE_NAME: "cyborg_legs", 	CYBORG_PARTS_VIEW_NODE: null},
	mb_lib.CYBORG_PART_TYPE_FEET: 	{CYBORG_PARTS_NODE_NAME: "cyborg_feet", 	CYBORG_PARTS_VIEW_NODE: null},
}
var nodes = {
	CYBORG_NAME: null,
	BODY_HEALTH_METER: null,
	BODY_ARMOR_METER: null,
	REPAIR_ARMOR_BUTTON: null,
	HEAL_BODY_BUTTON: null,
	MANAGE_CYBORG_PARTS_BUTTON: null,
	MANAGE_CYBORG_PARTS_POPUP: null,
	CYBORG_PARTS_LIST: null,
	}

func _ready():
	# TEMPORARY:
	body_health = int(randi() % max_health)
	body_armor = int(randi() % max_armor)
	
	for node_name in nodes:
		nodes[node_name] = find_node(node_name)
	
	for cyborg_part_type in cyborg_parts:
		cyborg_parts[cyborg_part_type][CYBORG_PARTS_VIEW_NODE] = find_node(cyborg_parts[cyborg_part_type][CYBORG_PARTS_NODE_NAME])
	
	nodes[BODY_HEALTH_METER].value = body_health
	nodes[BODY_ARMOR_METER].value = body_armor
	
	cyborg_name = mb_lib.CYBORG_NAMES[randi() % len(mb_lib.CYBORG_NAMES)]
	
	# Connections
	nodes[CYBORG_NAME].connect("text_entered", self, "name_entered")
	nodes[HEAL_BODY_BUTTON].connect("pressed", self, "heal_body_button_pressed")
	nodes[REPAIR_ARMOR_BUTTON].connect("pressed", self, "repair_armor_button_pressed")
	nodes[MANAGE_CYBORG_PARTS_BUTTON].connect("pressed", self, "manage_cyborg_parts_button_pressed")

func _process(delta):
	update_cyborg_gui()
	
func update_cyborg_gui():
	var health_meter = nodes[BODY_HEALTH_METER]
	var armor_meter = nodes[BODY_ARMOR_METER]
	nodes[CYBORG_NAME].text = cyborg_name
	health_meter.value = (float(body_health) / float(max_health)) * health_meter.max_value
	armor_meter.value = (float(body_armor) / float(max_armor)) * armor_meter.max_value
	
	var repair_btn = nodes[REPAIR_ARMOR_BUTTON]
	if body_armor < max_armor:
		repair_btn.set_disabled(false)
		var repair_armor_values = {
			"amt": calculate_armor_repair_cost(), 
			"currency": mb_lib.CURRENCY
			}
		repair_btn.text = "REPAIR ARMOR ({amt}{currency})".format(repair_armor_values)
	else:
		repair_btn.set_disabled(true)
		repair_btn.text = "REPAIR ARMOR"

	var heal_btn = nodes[HEAL_BODY_BUTTON]
	if body_health < max_health:
		heal_btn.set_disabled(false)
		var heal_values = {
			"amt": calculate_heal_cost(),
			"currency": mb_lib.CURRENCY
			}
		heal_btn.text = "HEAL ({amt}{currency})".format(heal_values)
	else:
		heal_btn.set_disabled(true)
		heal_btn.text = "HEAL"

func add_cyborg_part(type):
	cyborg_parts[type] = cyborg_part_preload.new()

func calculate_armor_repair_cost():
	return(max_armor - body_armor)

func calculate_heal_cost():
	return(max_health - body_health)

func name_entered(new_text):
	cyborg_name = new_text
	nodes[CYBORG_NAME].release_focus()
	print(cyborg_name)

func heal_body_button_pressed():
	var cost = calculate_heal_cost()
	# TODO: TAKE CURRENCY OUT OF BANK
	body_health = max_health

func repair_armor_button_pressed():
	var cost = calculate_armor_repair_cost()
	# TODO: TAKE CURRENCY OUT OF BANK
	body_armor = max_armor

func manage_cyborg_parts_button_pressed():
	nodes[MANAGE_CYBORG_PARTS_POPUP].popup_centered_minsize(Vector2(250, 100))
















